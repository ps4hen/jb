import{Int as e}from"./int64.js";import{mem as r}from"./mem.js";import{align as t}from"./utils.js";import{page_size as o}from"./offset.js";import{BufferView as i}from"./rw.js";import{View1 as f}from"./view.js";import*as n from"./offset.js";export function make_buffer(e,t){let o=new Uint8Array(1001),i=r.addrof(o),f=i.read64(n.view_m_vector),$=i.read32(n.view_m_length);i.write64(n.view_m_vector,e),i.write32(n.view_m_length,t);let a=new Uint8Array(o.length);a.set(o);let s=a.buffer;return i.write64(n.view_m_vector,f),i.write32(n.view_m_length,$),s}function check_magic_at(r,t){let o=[new e(3850979413,1447122753),new e(1413567809,2370326611),],i=[new e(32),new e(1007940799,2),],f=t?o:i,n=[r.read64(0),r.read64(8)];return n[0].eq(f[0])&&n[1].eq(f[1])}export function find_base(e,r,i){e=t(e,o);let f=(i?-1:1)*o;for(;!check_magic_at(e,r);)e=e.add(f);return e}export function get_view_vector(e){if(!ArrayBuffer.isView(e))throw TypeError(`object not a JSC::JSArrayBufferView: ${e}`);return r.addrof(e).readp(n.view_m_vector)}export function resolve_import(e){if(9727!==e.read16(0))throw Error(`instruction at ${e} is not of the form: jmp qword [rip + X]`);let r=e.read32(2),t=e.readp((0|r)+6);return t}export function init_syscall_array(e,r,t){if(!Number.isInteger(t))throw TypeError(`max_search_size is not a integer: ${t}`);if(t<0)throw Error(`max_search_size is less than 0: ${t}`);let o=make_buffer(r,t),f=new i(o),n=0,$=!1;for(let a=0;a<t;a++)if(114===f[a]&&100===f[a+1]&&108===f[a+2]&&111===f[a+3]){n=a,$=!0;break}if(!$)throw Error(`"rdlo" string not found in libkernel_web, base address: ${r}`);for(let s=0;s<n;s++)if(72===f[s]&&199===f[s+1]&&192===f[s+2]&&73===f[s+7]&&137===f[s+8]&&202===f[s+9]&&15===f[s+10]&&5===f[s+11]){let m=f.read32(s+3);e[m]=r.add(s),s+=11}}export function cstr(e){return e+="\0",f.from(e,e=>e.codePointAt(0))}export{jstr}from"./utils.js";