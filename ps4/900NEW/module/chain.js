import{Int as t,lohi_from_one as e}from"./int64.js";import{get_view_vector as s}from"./memtools.js";import{Addr as r}from"./mem.js";import*as i from"../config.js";export const syscall_map=new Map(Object.entries({read:3,write:4,open:5,close:6,getpid:20,setuid:23,getuid:24,accept:30,pipe:42,ioctl:54,munmap:73,mprotect:74,fcntl:92,socket:97,connect:98,bind:104,setsockopt:105,listen:106,getsockopt:118,fchmod:124,socketpair:135,fstat:189,getdirentries:196,__sysctl:202,mlock:203,clock_gettime:232,nanosleep:240,sched_yield:331,kqueue:362,kevent:363,rtprio_thread:466,mmap:477,ftruncate:480,shm_open:482,cpuset_getaffinity:487,cpuset_setaffinity:488,jitshm_create:533,jitshm_alias:534,evf_create:538,evf_delete:539,evf_set:544,evf_clear:545,set_vm_container:559,dmem_container:586,dynlib_dlsym:591,dynlib_get_list:592,dynlib_get_info:593,dynlib_load_prx:594,randomized_path:602,budget_get_ptype:610,thr_suspend_ucontext:632,thr_resume_ucontext:633,blockpool_open:653,blockpool_map:654,blockpool_unmap:655,blockpool_batch:657,aio_submit:661,kexec:661,aio_multi_delete:662,aio_multi_wait:663,aio_multi_poll:664,aio_multi_cancel:666,aio_submit_cmd:669,blockpool_move:673}));let argument_pops=["pop rdi; ret","pop rsi; ret","pop rdx; ret","pop rcx; ret","pop r8; ret","pop r9; ret",];export class ChainBase{constructor(t=4096,e=65536){this._is_dirty=!1,this.position=0;let r=new Uint32Array(4);this._return_value=r,this.retval_addr=s(r);let i=new Uint32Array(1);this._errno=i,this.errno_addr=s(i);let l=e+t,n=new ArrayBuffer(l),o=new DataView(n,e);this.stack=o,this.stack_addr=s(o),this.stack_size=t,this.full_stack_size=l}empty(){this.position=0}get is_dirty(){return this._is_dirty}clean(){this._is_dirty=!1}dirty(){this._is_dirty=!0}check_allow_run(){if(0===this.position)throw Error("chain is empty");if(this.is_dirty)throw Error("chain already ran, clean it first")}reset(){this.empty(),this.clean()}get retval_int(){return 0|this._return_value[0]}get retval(){return new t(this._return_value[0],this._return_value[1])}get retval_ptr(){return new r(this._return_value[0],this._return_value[1])}set retval(t){let s=e(t),r=this._return_value;r[0]=s[0],r[1]=s[1]}get retval_all(){let e=this._return_value;return[new t(e[0],e[1]),new t(e[2],e[3])]}set retval_all(t){let[s,r]=[e(t[0]),e(t[1])],i=this._return_value;i[0]=s[0],i[1]=s[1],i[2]=r[0],i[3]=r[1]}get errno(){return this._errno[0]}set errno(t){this._errno[0]=t}push_value(t){let s=this.position;if(s>=this.stack_size)throw Error(`no more space on the stack, pushed value: ${t}`);let r=e(t),i=this.stack;i.setUint32(s,r[0],!0),i.setUint32(s+4,r[1],!0),this.position+=8}get_gadget(t){let e=this.gadgets.get(t);if(void 0===e)throw Error(`gadget not found: ${t}`);return e}push_gadget(t){this.push_value(this.get_gadget(t))}push_call(t,...e){if(e.length>6)throw TypeError("push_call() does not support functions that have more than 6 arguments");for(let s=0;s<e.length;s++)this.push_gadget(argument_pops[s]),this.push_value(e[s]);(15&this.position)!=0&&this.push_gadget("ret"),"string"==typeof t?this.push_gadget(t):this.push_value(t)}push_syscall(t,...e){if("string"!=typeof t)throw TypeError(`syscall_name not a string: ${t}`);let s=syscall_map.get(t);if(void 0===s)throw Error(`syscall_name not found: ${t}`);let r=this.syscall_array[s];if(void 0===r)throw Error(`syscall number not in syscall_array: ${s}`);this.push_call(r,...e)}static init_class(t,e=[]){this.prototype.gadgets=t,this.prototype.syscall_array=e}run(){throw Error("not implemented")}push_end(){throw Error("not implemented")}push_get_errno(){throw Error("not implemented")}push_clear_errno(){throw Error("not implemented")}push_get_retval(){throw Error("not implemented")}push_get_retval_all(){throw Error("not implemented")}do_call(...t){if(this.position)throw Error("chain not empty");try{this.push_call(...t),this.push_get_retval(),this.push_get_errno(),this.push_end(),this.run()}finally{this.reset()}}call_void(...t){this.do_call(...t)}call_int(...t){return this.do_call(...t),0|this._return_value[0]}call(...e){this.do_call(...e);let s=this._return_value;return new t(s[0],s[1])}do_syscall(...t){if(this.position)throw Error("chain not empty");try{this.push_syscall(...t),this.push_get_retval(),this.push_get_errno(),this.push_end(),this.run()}finally{this.reset()}}syscall_void(...t){this.do_syscall(...t)}syscall_int(...t){return this.do_syscall(...t),0|this._return_value[0]}syscall(...e){this.do_syscall(...e);let s=this._return_value;return new t(s[0],s[1])}syscall_ptr(...t){this.do_syscall(...t);let e=this._return_value;return new r(e[0],e[1])}do_syscall_clear_errno(...t){if(this.position)throw Error("chain not empty");try{this.push_clear_errno(),this.push_syscall(...t),this.push_get_retval(),this.push_get_errno(),this.push_end(),this.run()}finally{this.reset()}}sysi(...t){let e=this._errno;this.do_syscall_clear_errno(...t);let s=e[0];if(0!==s)throw Error(`syscall(${t[0]}) errno: ${s}`);return 0|this._return_value[0]}sys(...e){let s=this._errno;this.do_syscall_clear_errno(...e);let r=s[0];if(0!==r)throw Error(`syscall(${e[0]}) errno: ${r}`);let i=this._return_value;return new t(i[0],i[1])}sysp(...t){let e=this._errno;this.do_syscall_clear_errno(...t);let s=e[0];if(0!==s)throw Error(`syscall(${t[0]}) errno: ${s}`);let i=this._return_value;return new r(i[0],i[1])}}export function get_gadget(t,e){let s=t.get(e);if(void 0===s)throw Error(`gadget not found: ${e}`);return s}function load_fw_specific(t){if(65536&t)throw RangeError("ps5 not supported yet");let e=65535&t;if(e<1792)throw RangeError("PS4 firmwares < 7.00 isn't supported");if(2048<=e&&e<=2304)return import("../rop/900.js");throw RangeError("firmware not supported")}export let gadgets=null;export let libwebkit_base=null;export let libkernel_base=null;export let libc_base=null;export let init_gadget_map=null;export let Chain=null;export async function init(){let t=await load_fw_specific(i.target);Chain=t.Chain,t.init(Chain),{gadgets,libwebkit_base,libkernel_base,libc_base,init_gadget_map}=t}